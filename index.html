<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fietsweer Pro: Paarse Route & Windrozen</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        #controls {
            position: absolute;
            top: 20px; left: 20px; z-index: 1000;
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            width: 320px; max-height: 90vh; overflow-y: auto;
        }
        h2 { margin-top: 0; font-size: 20px; color: #333; }
        h3 { font-size: 16px; margin-bottom: 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;}
        
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 13px; color: #444;}
        input, select, button { width: 100%; margin-top: 5px; padding: 10px; box-sizing: border-box; border-radius: 6px; border: 1px solid #ddd; }
        
        button.primary { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 15px; }
        button.primary:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; color: white; border: none; cursor: pointer; margin-top: 5px; }
        button.secondary:hover { background-color: #5a6268; }

        .legend { display: flex; justify-content: space-between; margin-top: 15px; font-size: 12px; }
        .dot { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
        
        #status { margin-top: 10px; font-size: 13px; color: #666; font-style: italic; }
        
        /* NIEUWE STIJLEN VOOR DE WINDROOS */
        .wind-arrow-container {
            display: flex; align-items: center; justify-content: center;
            /* Zorgt dat het icoon netjes om zijn as draait */
            transform-origin: center center;
        }
        /* Een lichte schaduw achter de cirkel zodat hij loskomt van de kaart */
        .wind-rose-svg {
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body>

<div id="controls">
    <h2>üö¥ Fietsweer Pro</h2>
    
    <h3>1. Route Kiezen</h3>
    <input type="file" id="gpxInput" accept=".gpx">
    <div style="text-align: center; margin: 5px 0;">- OF -</div>
    <select id="savedRoutesSelect">
        <option value="">-- Kies opgeslagen route --</option>
    </select>
    <button class="secondary" onclick="loadSavedRoute()">Laad Geselecteerde Route</button>

    <h3>2. Planning</h3>
    <label>Startdatum & Tijd</label>
    <input type="datetime-local" id="startTime">

    <label>Gemiddelde snelheid (km/u)</label>
    <input type="number" id="speed" value="25" min="10" max="50">

    <button class="primary" onclick="calculateWeather()">‚òÄÔ∏è Bereken Weer & Wind</button>
    
    <div id="saveSection" style="display:none; border-top: 1px solid #eee; margin-top: 15px; padding-top: 10px;">
        <label>Route opslaan als:</label>
        <input type="text" id="routeNameInput" placeholder="Bijv. Rondje Veluwe">
        <button class="secondary" onclick="saveCurrentRoute()">üíæ Route Opslaan</button>
    </div>

    <div id="status"></div>

    <div class="legend">
        <span><span class="dot" style="background:red;"></span>Tegenwind</span>
        <span><span class="dot" style="background:blue;"></span>Zijwind</span>
        <span><span class="dot" style="background:green;"></span>Meewind</span>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- SETUP ---
    const map = L.map('map').setView([52.1, 5.1], 8);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',    maxZoom: 20 }).addTo(map);

    let currentRoutePoints = []; 
    // We gebruiken nu twee lagen: √©√©n voor de route lijn, √©√©n voor de wind markers
    let routeLayerGroup = L.layerGroup().addTo(map);
    let markerLayerGroup = L.layerGroup().addTo(map);

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('startTime').value = now.toISOString().slice(0,16);

    updateSavedRoutesDropdown();

    // --- GPX ---
    document.getElementById('gpxInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const gpx = parser.parseFromString(e.target.result, "text/xml");
            const trkpts = gpx.getElementsByTagName('trkpt');
            currentRoutePoints = [];
            for (let pt of trkpts) {
                currentRoutePoints.push([parseFloat(pt.getAttribute('lat')), parseFloat(pt.getAttribute('lon'))]);
            }
            showPreviewLine();
            document.getElementById('saveSection').style.display = 'block';
            document.getElementById('status').innerText = "Route geladen. Klik op 'Bereken Weer'.";
        };
        reader.readAsText(file);
    });

    // AANGEPAST: Preview lijn is nu PAARS en solide
    function showPreviewLine() {
        routeLayerGroup.clearLayers();
        markerLayerGroup.clearLayers();
        if (currentRoutePoints.length > 0) {
            // Mooie paarse kleur (#8e44ad), iets dikker, geen stippellijn meer
            const line = L.polyline(currentRoutePoints, {color: '#8e44ad', weight: 5, opacity: 0.8}).addTo(routeLayerGroup);
            map.fitBounds(line.getBounds());
        }
    }

    // --- BEREKENING ---
    async function calculateWeather() {
        if (currentRoutePoints.length === 0) { alert("Geen route geladen!"); return; }
        
        const speed = parseFloat(document.getElementById('speed').value);
        const startTime = new Date(document.getElementById('startTime').value);
        const status = document.getElementById('status');
        
        status.innerText = "Data ophalen en rekenen...";
        routeLayerGroup.clearLayers(); 
        markerLayerGroup.clearLayers(); // Ook markers wissen bij nieuwe berekening

        let totalDist = 0;
        let lastWeatherDist = -100;
        let chunkStartIdx = 0;
        let lastWeather = null;

        for (let i = 1; i < currentRoutePoints.length; i++) {
            const p1 = currentRoutePoints[i-1];
            const p2 = currentRoutePoints[i];
            const dist = getDistance(p1[0], p1[1], p2[0], p2[1]);
            totalDist += dist;

            // Elke 15km
            if (totalDist - lastWeatherDist >= 15 || i === 1) {
                if (i > 1 && lastWeather) {
                    drawColoredSegment(chunkStartIdx, i, lastWeather);
                }
                lastWeatherDist = totalDist;
                chunkStartIdx = i;

                const hoursCycling = totalDist / speed;
                const arrivalTime = new Date(startTime.getTime() + hoursCycling * 60 * 60 * 1000);
                
                lastWeather = await getWeatherData(p2[0], p2[1], arrivalTime);
                
                if (lastWeather) {
                    addMarker(p2[0], p2[1], lastWeather, Math.round(totalDist), arrivalTime);
                }
            }
        }
        
        if (lastWeather) {
            drawColoredSegment(chunkStartIdx, currentRoutePoints.length - 1, lastWeather);
        }
        
        status.innerText = "Klaar!";
    }

    function drawColoredSegment(startIndex, endIndex, weather) {
        for (let j = startIndex; j < endIndex; j++) {
            const pA = currentRoutePoints[j];
            const pB = currentRoutePoints[j+1];
            const bearing = getBearing(pA[0], pA[1], pB[0], pB[1]);
            const color = getWindColor(bearing, weather.dir);
            // Lijn iets dikker gemaakt (weight: 6)
            L.polyline([pA, pB], {color: color, weight: 6, opacity: 0.9}).addTo(routeLayerGroup);
        }
    }

    // --- KLEUREN LOGICA (Jouw werkende versie) ---
    function getWindColor(bearing, windDir) {
        let diff = Math.abs(bearing - windDir);
        if (diff > 180) diff = 360 - diff; 
        if (diff < 45) return 'green';  // Tegenwind op kaart (label zegt Tegenwind)
        if (diff > 135) return 'red';   // Meewind op kaart (label zegt Meewind)
        return 'blue';                  // Zijwind
    }

    // --- WISKUNDE ---
    function getDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));}
    function getBearing(lat1, lon1, lat2, lon2) { const y = Math.sin(lon2 - lon1) * Math.cos(lat2); const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1); return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;}

    // --- API CALL ---
    async function getWeatherData(lat, lon, time) {
        const dateStr = time.toISOString().split('T')[0];
        const hour = time.getHours();
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_10m,winddirection_10m&start_date=${dateStr}&end_date=${dateStr}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if(data.hourly && data.hourly.windspeed_10m[hour] !== undefined) {
                return { spd: data.hourly.windspeed_10m[hour], dir: data.hourly.winddirection_10m[hour] };
            }
            return null;
        } catch(e) { console.log(e); return null; }
    }

    // --- NIEUWE MARKER FUNCTIE: WINDROOS ---
    function addMarker(lat, lon, w, km, time) {
        // Kleur bepalen voor de naald
        let color = '#0099ff'; // Blauw
        if (w.spd >= 15) color = 'orange';
        if (w.spd >= 30) color = 'red';

        const size = 40; // Grootte van het icoon

        // SVG Windroos Ontwerp: Witte cirkel met gekleurde naald
        const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 40 40" class="wind-rose-svg">
             <circle cx="20" cy="20" r="18" fill="rgba(255,255,255,0.9)" stroke="#ccc" stroke-width="1"/>
             <path d="M20 5 L30 32 L10 32 Z" fill="${color}" />
        </svg>`;

        const icon = L.divIcon({ 
            // De container draait de hele SVG op basis van windrichting
            html: `<div class="wind-arrow-container" style="transform: rotate(${w.dir}deg)">${svg}</div>`, 
            className: '', // Lege class om standaard leaflet stijlen te voorkomen
            iconSize: [size, size],
            // HIER ZIT DE TRUC VOOR DE PLAATSING:
            // Normaal anker is [size/2, size/2] (het midden).
            // Door de Y-waarde kleiner te maken (bijv. 0), schuift het icoon naar BENEDEN t.o.v. het punt.
            iconAnchor: [size / 2, 0] 
        });
        
        // Marker toevoegen aan de speciale markerLayerGroup
        L.marker([lat, lon], {icon: icon}).addTo(markerLayerGroup)
         .bindPopup(`<b>${km}km punt</b><br>Tijd: ${time.getHours()}:00<br>Wind: ${w.spd} km/u`);
    }

    // --- OPSLAAN & LADEN ---
    function saveCurrentRoute() {
        const name = document.getElementById('routeNameInput').value;
        if (!name || currentRoutePoints.length === 0) { alert("Geen naam of route!"); return; }
        localStorage.setItem('fietsroute_' + name, JSON.stringify(currentRoutePoints));
        alert('Route opgeslagen!');
        updateSavedRoutesDropdown();
    }
    function updateSavedRoutesDropdown() {
        const select = document.getElementById('savedRoutesSelect');
        select.innerHTML = '<option value="">-- Kies opgeslagen route --</option>';
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('fietsroute_')) {
                const name = key.replace('fietsroute_', '');
                const opt = document.createElement('option');
                opt.value = key; opt.innerText = name;
                select.appendChild(opt);
            }
        }
    }
    function loadSavedRoute() {
        const key = document.getElementById('savedRoutesSelect').value;
        if (!key) return;
        const data = localStorage.getItem(key);
        if (data) {
            currentRoutePoints = JSON.parse(data);
            showPreviewLine();
            document.getElementById('status').innerText = "Opgeslagen route geladen. Kies tijd en klik 'Bereken'.";
        }
    }
</script>

</body>
</html>